import logging
import random
from datetime import time
from typing import Dict

import telegram
from telegram import Bot
from telegram.ext import JobQueue, Job

THE_TIME = time(hour=13, minute=37)
log = logging.getLogger('meme-bot')
user_jobs = {}  # type: Dict[telegram.User, Job]
exactly_1337_emoji = "ðŸŽ®ðŸ¸ðŸŽªðŸ¯ðŸ’‡ðŸŽ¥ðŸðŸ³ðŸ’´ðŸ“²ðŸ•ðŸ’±ðŸ†ðŸ¼ðŸ‘±ðŸ•ðŸ‡ðŸ‚ðŸ’µðŸ”ðŸ’¤ðŸ”™ðŸ¡ðŸ‹ðŸŒ‘ðŸ’£ðŸ›ðŸŽ¿ðŸ¡ðŸŒ¹ðŸ‘€ðŸŽ¸ðŸŸðŸ—¾ðŸ˜ðŸ¹ðŸŽðŸ“ªðŸ—ðŸ²ðŸ•¢ðŸ‚ðŸ’¡ðŸŽ´ðŸ²ðŸ‘«ðŸ”’ðŸ‘®ðŸ•–ðŸ•ðŸŽ‘ðŸŒ˜ðŸ”ƒðŸ’" \
                     "ðŸˆðŸ”ðŸ­ðŸ‘ˆðŸ”ðŸ‹ðŸ’ðŸ’‡ðŸ•§ðŸ”ŸðŸ’¶ðŸŽ‚ðŸŽðŸ‚ðŸ’ˆðŸ‹ðŸðŸ’žðŸ—¾ðŸ’ðŸ”†ðŸ“²ðŸ‘ˆðŸ’¯ðŸ• ðŸ“‰ðŸ’™ðŸ‘»ðŸ‘•ðŸ”ðŸ½ðŸ‘‚ðŸŽ°ðŸŒðŸ” ðŸˆðŸ•™ðŸŽ¨ðŸ’«ðŸ’€ðŸ€ðŸ‘¥ðŸ’ðŸ“ ðŸ•¢ðŸŒ›ðŸ‘®ðŸ“ðŸŒžðŸ‘¬ðŸ’¸ðŸ»ðŸ”œðŸŒ¹" \
                     "ðŸ”¡ðŸŽ½ðŸŽ©ðŸðŸ’€ðŸ’¾ðŸ’ŒðŸ‘“ðŸŽŠðŸŒºðŸ‚ðŸ¤ðŸŽ¹ðŸ¡ðŸŒ‡ðŸ‘°ðŸŒ¾ðŸŽ¦ðŸ’•ðŸŸðŸ¨ðŸ’ªðŸŒ˜ðŸˆðŸ”œðŸ’†ðŸ¶ðŸ‘³ðŸŒ¸ðŸƒðŸ¯ðŸ‘ƒðŸµðŸ“µðŸ‘¾ðŸ·ðŸ—»ðŸ•ðŸ‘™ðŸ·ðŸ‘•ðŸƒðŸ‘€ðŸ•’ðŸ‘¢ðŸŸðŸ’­ðŸ’½ðŸ’ºðŸ’‡ðŸ¶ðŸ“®ðŸŒ‡" \
                     "ðŸ“„ðŸŽ‡ðŸ’ðŸ‘—ðŸ”­ðŸ¤ðŸ“µðŸ’²ðŸ”¨ðŸ±ðŸ—ðŸ¦ðŸŽ¯ðŸ”ðŸŽªðŸ‘“ðŸ‘—ðŸªðŸ’±ðŸ”ðŸ‘ŸðŸŒ¾ðŸ•‚ðŸ’˜ðŸ’’ðŸ”ˆðŸðŸ€ðŸ•™ðŸ“¥ðŸ‘¥ðŸ•¥ðŸŒ¶ðŸ€ðŸ”‚ðŸ“‹ðŸ”‡ðŸŒ‰ðŸ‘ðŸ“”ðŸ”·ðŸ©ðŸ‘ðŸ‘˜ðŸŒŠðŸ”€ðŸ“£ðŸŒƒðŸ”ðŸ”„ðŸ‘°ðŸ¨ðŸŽ²ðŸ”™" \
                     "ðŸ¬ðŸ’œðŸ‘ŽðŸ‘œðŸ¢ðŸ‘£ðŸ“«ðŸºðŸ”ƒðŸ’¡ðŸ‘£ðŸ‘‹ðŸ‘¬ðŸŒ˜ðŸ­ðŸŽ»ðŸŒˆðŸ‘·ðŸ¸ðŸŒ¿ðŸœðŸŽ©ðŸ–ðŸ”¡ðŸ£ðŸðŸ§ðŸ™ðŸ‘¥ðŸ“˜ðŸŽˆðŸ‘½ðŸ”ªðŸ’¢ðŸ£ðŸðŸŒ¸ðŸ‘¾ðŸŽðŸƒðŸƒðŸ‘”ðŸ“ªðŸ•œðŸ“ŒðŸ’¹ðŸ’„ðŸ“‚ðŸ•ðŸ‘‡ðŸ’¥ðŸ•œðŸŒ‰ðŸ‘Œ" \
                     "ðŸ”…ðŸ‘ªðŸ“¡ðŸ’£ðŸðŸ”·ðŸ‘¥ðŸ”´ðŸŽ´ðŸ ðŸŒ¾ðŸ”¸ðŸ’ŸðŸ¨ðŸŽ³ðŸ“¹ðŸ”–ðŸ‘¸ðŸ’¯ðŸ§ðŸ£ðŸðŸŽŠðŸ”¡ðŸ®ðŸ’ƒðŸ’ªðŸ‘¸ðŸŽ ðŸ’ðŸ”¡ðŸðŸŽˆðŸ”½ðŸ”«ðŸ”¬ðŸ”´ðŸ”•ðŸ•›ðŸ••ðŸ‘˜ðŸ“°ðŸ“ªðŸ¥ðŸŽ£ðŸ’¿ðŸ”—ðŸ©ðŸ”‡ðŸðŸ”·ðŸ‘¦ðŸ‚ðŸƒ" \
                     "ðŸ¾ðŸ’šðŸšðŸðŸ°ðŸ“•ðŸ‘¥ðŸ­ðŸ’”ðŸ°ðŸ•˜ðŸªðŸ”„ðŸ‘—ðŸŽ†ðŸ‹ðŸ•–ðŸšðŸ“ðŸ–ðŸªðŸŽ¿ðŸŒ½ðŸ”¨ðŸ“ºðŸ‘¥ðŸŽðŸ‘¢ðŸ®ðŸ“¨ðŸ‘•ðŸ”ðŸšðŸ«ðŸ¼ðŸ“ðŸ’”ðŸŒ‚ðŸ•ðŸ’•ðŸ‘£ðŸ“†ðŸŒ ðŸŒŠðŸµðŸ®ðŸŒ°ðŸ‘€ðŸ‘ºðŸðŸ• ðŸšðŸ”¼ðŸŒŒ" \
                     "ðŸŒ…ðŸ‘œðŸ’°ðŸŽ‰ðŸ’„ðŸ‘ðŸŒ“ðŸ‘§ðŸŽ·ðŸŽ³ðŸ“ƒðŸƒðŸ‘ŠðŸ²ðŸ’¯ðŸ“„ðŸ’ŒðŸŽ“ðŸ”ŠðŸ“œðŸ©ðŸ‘”ðŸ”‡ðŸ¬ðŸ’šðŸŒ¿ðŸ’¦ðŸ…ðŸªðŸ‘‚ðŸŽ¶ðŸ¯ðŸ’²ðŸŽðŸ”±ðŸˆðŸ¬ðŸ”µðŸ‘‰ðŸ³ðŸ¢ðŸ©ðŸ“»ðŸ”‚ðŸ“»ðŸŽ±ðŸ‘žðŸŽ²ðŸ‘‡ðŸŽ‚ðŸ”ðŸŒ’ðŸ‘žðŸ‘" \
                     "ðŸŽðŸ’ŠðŸŒðŸ’£ðŸ¨ðŸ”œðŸ’ŽðŸ¨ðŸ’°ðŸŒðŸŽ‹ðŸ©ðŸºðŸŽ¿ðŸ•”ðŸ‘™ðŸðŸŽ¿ðŸ—¾ðŸŒšðŸ’€ðŸ‘„ðŸ“¯ðŸŒ‚ðŸžðŸ‘‰ðŸ‘…ðŸŒ†ðŸˆðŸ”²ðŸ“§ðŸ‘–ðŸŒ½ðŸƒðŸ”¥ðŸŽ¾ðŸŒðŸ°ðŸ”ðŸ“¢ðŸŒ€ðŸ“–ðŸ”‘ðŸ‘“ðŸ”—ðŸ‘¯ðŸ‘ŒðŸ•›ðŸ‘©ðŸ†ðŸ³ðŸ’‰ðŸ“†ðŸ" \
                     "ðŸ“‘ðŸŒ¶ðŸ”´ðŸ´ðŸ•”ðŸŽ€ðŸ‘ðŸ‘ŸðŸ¢ðŸ¯ðŸ”†ðŸŒŽðŸŸðŸ“ˆðŸ“–ðŸ‡ðŸŽ±ðŸ’‹ðŸ” ðŸ“ðŸ’ƒðŸ”®ðŸ”§ðŸžðŸ‘ðŸŒµðŸ±ðŸ‚ðŸ»ðŸ•¤ðŸŽ¶ðŸ“¨ðŸ’ðŸ¼ðŸ’ðŸ‘©ðŸ‘œðŸ•ŸðŸ‘†ðŸ’„ðŸ’ ðŸ•¡ðŸ‘šðŸ“¼ðŸ¯ðŸ‘¥ðŸ¯ðŸ”“ðŸŸðŸŽ“ðŸ”³ðŸ“‹ðŸ•¦ðŸ“ª" \
                     "ðŸ•œðŸ•ƒðŸ”ðŸ¤ðŸ’‰ðŸ•‘ðŸ”¼ðŸ’°ðŸŽðŸðŸ‘“ðŸ”£ðŸŽðŸ”‹ðŸ¾ðŸ“°ðŸ”¨ðŸ•§ðŸŽ²ðŸ’‰ðŸ’ðŸ’ŠðŸ«ðŸŒ·ðŸ”¯ðŸ¦ðŸ‘‹ðŸ’„ðŸ¯ðŸ‘•ðŸŽˆðŸ”¡ðŸŽ®ðŸ‘µðŸ“ðŸ‘˜ðŸ—¼ðŸðŸ€ðŸŒ˜ðŸ”­ðŸ’ªðŸðŸ”¼ðŸŒ¾ðŸŒ„ðŸ“™ðŸ’ŠðŸ‘‰ðŸ•žðŸ‘€ðŸ““ðŸŽµðŸ“šðŸ“‡" \
                     "ðŸ’»ðŸ”¼ðŸ’¡ðŸ“šðŸ¦ðŸ—ðŸ”¨ðŸ·ðŸ¸ðŸ’¹ðŸ’·ðŸ‘„ðŸ—»ðŸ“®ðŸðŸŒºðŸªðŸ”’ðŸ‘ŒðŸ’€ðŸ’—ðŸ‘±ðŸ”ˆðŸŒðŸ’»ðŸ’°ðŸ’¼ðŸœðŸŽðŸ“€ðŸ ðŸ”šðŸŽ¡ðŸ“…ðŸ• ðŸ’›ðŸ•¡ðŸ‘ðŸ¢ðŸ£ðŸ•§ðŸ‘ªðŸ¬ðŸ“³ðŸ’™ðŸ”‰ðŸ‘„ðŸ”§ðŸ¯ðŸ‘¥ðŸ‘¤ðŸ••ðŸŽ“ðŸ“¹ðŸ’¥" \
                     "ðŸ”…ðŸ‘„ðŸ’¬ðŸ«ðŸ’”ðŸ…ðŸ‘µðŸ“²ðŸ´ðŸ”’ðŸ“»ðŸ¦ðŸ¥ðŸ—½ðŸ“·ðŸŒ´ðŸŽ’ðŸ¦ðŸŒ•ðŸŒ¸ðŸ•ƒðŸŒ ðŸƒðŸ‡ðŸ¤ðŸŽ¶ðŸŽðŸ”­ðŸ’µðŸŽ¿ðŸ—ðŸªðŸ¼ðŸ®ðŸ”¨ðŸ•¤ðŸ“˜ðŸƒðŸ¨ðŸ’“ðŸ“¢ðŸŒ·ðŸ“„ðŸ‘ƒðŸºðŸ“¦ðŸ”·ðŸ“ ðŸ“³ðŸŒ›ðŸŽ¼ðŸ’ŽðŸ‘®ðŸ‘…ðŸ" \
                     "ðŸ‘¶ðŸ“£ðŸ‘¾ðŸ”µðŸ”…ðŸ“‘ðŸ“™ðŸ‘—ðŸ”€ðŸ ðŸŒ“ðŸ…ðŸ¼ðŸ…ðŸ“ŽðŸŒ»ðŸ’¢ðŸŽ³ðŸ•žðŸŽŒðŸ‘­ðŸŽ´ðŸ’ðŸ¸ðŸ¢ðŸ’µðŸ ðŸ’ðŸšðŸ“ðŸ’¿ðŸ“´ðŸ¢ðŸ’”ðŸ”¨ðŸ“ŠðŸ’€ðŸŸðŸ‰ðŸ’‚ðŸŒ²ðŸ’§ðŸ’¶ðŸ’”ðŸ“‘ðŸ´ðŸ’¦ðŸŽ«ðŸŽªðŸ’™ðŸŒ¾ðŸ”šðŸ“•ðŸ”¤" \
                     "ðŸ‘µðŸ”‘ðŸŒ¾ðŸ”‡ðŸ„ðŸ²ðŸŽˆðŸŽ¿ðŸ“ŽðŸ’›ðŸ’—ðŸ’ƒðŸ„ðŸ’™ðŸðŸœðŸŽ·ðŸ“£ðŸðŸˆðŸ‘ðŸ¢ðŸ”šðŸŽ‹ðŸ‚ðŸ’ðŸðŸðŸ’³ðŸ”†ðŸ”¼ðŸŒ™ðŸ‘¯ðŸ•¤ðŸ‘ðŸ¦ðŸ“ ðŸ”²ðŸ‘±ðŸŒ€ðŸ‘ðŸ­ðŸ¾ðŸ”‚ðŸŽ°ðŸ”»ðŸ‘²ðŸ•˜ðŸŽ¬ðŸŒˆðŸŒœðŸ‘²ðŸŽ¯ðŸŽ¤" \
                     "ðŸ’—ðŸ’¯ðŸ•˜ðŸ’¹ðŸ’ºðŸ””ðŸ’´ðŸŽðŸ‘˜ðŸ”„ðŸ‘¯ðŸ‘ªðŸ‹ðŸ”­ðŸŽ¿ðŸŒžðŸŒ–ðŸ‘–ðŸŽ¬ðŸŽ‡ðŸ•›ðŸŒðŸ‘–ðŸ•šðŸ”·ðŸ“”ðŸœðŸŸðŸŽºðŸ’ðŸ“¬ðŸ•—ðŸ”„ðŸŒºðŸ­ðŸ’«ðŸ”™ðŸ’ðŸŽðŸ’•ðŸŽ‡ðŸ’†ðŸ’‡ðŸ§ðŸ”½ðŸŒŸðŸ‘¾ðŸ‰ðŸ”ðŸ·ðŸ”¡ðŸ‘§ðŸ’™ðŸ¯" \
                     "ðŸ§ðŸŒ˜ðŸ¸ðŸ˜ðŸžðŸ‘½ðŸ“žðŸ“ðŸ–ðŸ’‚ðŸ”‚ðŸ·ðŸ£ðŸ”ðŸ‹ðŸ¦ðŸ˜ðŸ•¥ðŸŽðŸŽŽðŸŒŒðŸŽ„ðŸŽ±ðŸ‘ðŸ“©ðŸ“‘ðŸ’–ðŸŒðŸ”£ðŸ“®ðŸ¬ðŸŽðŸ’ðŸ“ðŸ”¥ðŸ‘„ðŸ¬ðŸ”¹ðŸŽ«ðŸœðŸŽ»ðŸ—ðŸ“žðŸŒ°ðŸŽ®ðŸŽ°ðŸŽ’ðŸ”£ðŸ‘‘ðŸŒ‡ðŸŽ¢ðŸ”²ðŸ‘“ðŸ‘¢" \
                     "ðŸ’°ðŸŒŸðŸ†ðŸ„ðŸ’¯ðŸ‘”ðŸ’•ðŸ’¤ðŸ“šðŸ‘°ðŸŽ‰ðŸ“‡ðŸ“›ðŸºðŸŒðŸ”‘ðŸœðŸ”™ðŸ¦ðŸ‰ðŸ•ðŸ‘ŸðŸ‘¡ðŸ¬ðŸ ðŸ“¥ðŸ”·ðŸ‹ðŸ’˜ðŸŽ±ðŸŒ…ðŸ”£ðŸ’‡ðŸ•‚ðŸ’³ðŸˆðŸŽ„ðŸ€ðŸŽ¸ðŸŒŸðŸ¤ðŸ£ðŸ“³ðŸ”£ðŸ‘¾ðŸ³ðŸ‘¼ðŸ‡ðŸ›ðŸ“´ðŸŽµðŸ•ðŸ“‰ðŸ“´" \
                     "ðŸ¤ðŸ“ƒðŸŽ³ðŸ•”ðŸŒ‚ðŸ¦ðŸŒ‡ðŸ°ðŸƒðŸ‘¹ðŸ”¯ðŸ—»ðŸ˜ðŸ©ðŸ”ðŸ”·ðŸ’µðŸ’»ðŸ“…ðŸŽ€ðŸ‘‹ðŸ”’ðŸ®ðŸ”“ðŸ•ŸðŸºðŸŽ¡ðŸŒ¸ðŸ”¨ðŸ¯ðŸ’›ðŸŒ”ðŸ—»ðŸ•–ðŸ—ðŸ’³ðŸ•€ðŸ€ðŸ¾ðŸ†ðŸ¥ðŸ‘«ðŸ”²ðŸŒ¶ðŸ’®ðŸ“±ðŸ‘±ðŸŒ¼ðŸ‘£ðŸ’²ðŸ“ðŸ‘ðŸ’†ðŸŒ±" \
                     "ðŸŽ·ðŸŽ¿ðŸ’•ðŸ‘•ðŸ’ðŸŽ¼ðŸ”‹ðŸŒ¶ðŸšðŸ“„ðŸ ðŸŒ·ðŸ•›ðŸ•ƒðŸ“¬ðŸ„ðŸ’‘ðŸ’ðŸŽ¡ðŸ”™ðŸŒµðŸŽ¦ðŸˆðŸ’ŠðŸŽ‰ðŸŽ°ðŸ“ªðŸ¢ðŸ”šðŸªðŸ£ðŸ’§ðŸŽðŸŒ†ðŸ‘°ðŸ”¦ðŸ‘ðŸ“ƒðŸ”–ðŸ¥ðŸ‡ðŸ’¥ðŸ’¹ðŸ§ðŸ”€ðŸŽ„ðŸ“®ðŸ’‡ðŸ‘¡ðŸŽ¿ðŸŒ¼ðŸƒðŸžðŸ‘" \
                     "ðŸ•šðŸºðŸˆðŸ‘‡ðŸƒðŸ’­ðŸ—ðŸ‘‘ðŸŒðŸŽµðŸŽðŸ’ƒðŸ”“ðŸ‘¹ðŸ‘†ðŸˆðŸŒšðŸ’©ðŸ‘±ðŸ“ƒðŸ”ŽðŸðŸ“‘ðŸ“ˆðŸ”¸ðŸŒžðŸ¡ðŸ•ŸðŸ”ðŸ•’ðŸ’¯ðŸ‘‡ðŸ‘²ðŸŽˆðŸ”ŒðŸ’ªðŸ“¶ðŸ¦ðŸ¾ðŸ‰ðŸ¤ðŸ“’ðŸ“ðŸŒ™ðŸ‰ðŸ•ŸðŸ”‰ðŸŽ­ðŸŒ‡ðŸ«ðŸ“ðŸ¢ðŸ‘ðŸ’š" \
                     "ðŸ“„ðŸŽ‘ðŸ“¼ðŸ²ðŸ‘¡ðŸ”‹ðŸ™ðŸ‘‘ðŸ«ðŸ’ƒðŸŒ´ðŸ‘©ðŸ”·ðŸ¡ðŸŽ‡ðŸ’ ðŸŽµðŸ“šðŸ“ðŸ“–ðŸ”ˆðŸ””ðŸ“‘ðŸ¥ðŸ’ðŸ‘³ðŸŒ³ðŸŽ¢ðŸ”²ðŸ¯ðŸŒŒðŸ’‰ðŸ“—ðŸ“•ðŸŒðŸ”’ðŸ‘¾ðŸ•–ðŸ¨ðŸ’‰ðŸ’§ðŸ”¬ðŸ•¥ðŸ•ðŸ±ðŸ“£ðŸ‘®ðŸ¦ðŸ’“ðŸ• ðŸ’ŽðŸŒðŸŽðŸƒðŸ’Ž" \
                     "ðŸ€ðŸ”ðŸðŸ›ðŸ’±ðŸ’¨ðŸ‘©ðŸ”…ðŸ•”ðŸŽ‚ðŸ¢ðŸ‘­ðŸ”‡ðŸŽƒðŸ‘©ðŸ”³ðŸ›ðŸ‘ŠðŸðŸ“•ðŸ—¾ðŸ‘šðŸŒŽðŸ‡ðŸ’ðŸŸðŸ”ðŸ°ðŸ’œðŸ†ðŸ­ðŸ‘—ðŸŒ±ðŸŒ²ðŸ”’ðŸ”¸ðŸ’œðŸ„ðŸ“šðŸŒðŸ’§ðŸ•€ðŸŽºðŸ’•ðŸŒ´ðŸ“°ðŸ”¬ðŸµðŸŒðŸ‘ªðŸ“«ðŸ•ðŸŽ‚ðŸ¯" \
                     "ðŸ•œðŸŒœðŸ”˜ðŸ‘›ðŸ¤ðŸŽ»ðŸ«ðŸ’ðŸ«ðŸ’¦ðŸ¤ðŸ–ðŸŒºðŸ•ŸðŸ…ðŸ£ðŸðŸ•™ðŸ™ðŸ“œðŸ–ðŸšðŸ’•ðŸ’˜ðŸ”«ðŸ’¿ðŸ‘¡ðŸ“‰ðŸ’’ðŸ´ðŸ’›ðŸ±ðŸ¬ðŸ“ŠðŸ‘¹ðŸ³ðŸ’–ðŸ“¯ðŸ’ðŸ’±ðŸ—¼ðŸ“¼ðŸ˜ðŸ“”ðŸ‘ˆðŸŽ†ðŸ´ðŸ“µðŸ”·ðŸðŸ©ðŸ’¡ðŸŒ›" \
                     "ðŸ”žðŸ“ðŸ’‘ðŸ”€ðŸ‘‹ðŸŒ¾ðŸµðŸ¤ðŸ¢ðŸ†ðŸ’¥ðŸŽ‡ðŸ‘ŒðŸ”¦ðŸ ðŸ•ðŸ”’ðŸ—ðŸŽŠðŸŒ»ðŸ’—ðŸ“™ðŸ¥ðŸŽ¬ðŸ¯ðŸŠðŸ“ðŸ‘ðŸ“¼ðŸ‘ªðŸ’ðŸ‘ªðŸ©ðŸ’¦ðŸ«ðŸ”·ðŸ´ðŸ“‘ðŸ“© "


def manage_subscription(user: telegram.User, job_queue: JobQueue) -> str:
    if user in user_jobs:
        return unsubscribe(user)
    else:
        return subscribe(job_queue, user)


def subscribe(job_queue: JobQueue, user: telegram.User) -> str:
    job = job_queue.run_daily(callback=notify_subscriber, time=THE_TIME, context=user, name="1337")
    user_jobs[user] = job
    return "You will be notified."


def unsubscribe(user: telegram.User) -> str:
    job = user_jobs.pop(user)
    job.schedule_removal()
    return "You won't be notified anymore."


def notify_subscriber(bot: Bot, job: Job) -> None:
    user = job.context  # type: telegram.User
    text = "It is time.\n\n" + "".join(random.sample(exactly_1337_emoji, random.randint(13, 37)))
    try:
        bot.send_message(chat_id=user.id, text=text)
    except telegram.error.Unauthorized:
        unsubscribe(user)
        log.info('Someone blocked the bot but still had an active subscription. Unsubscribed him.')
